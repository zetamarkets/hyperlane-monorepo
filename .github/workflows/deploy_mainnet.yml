name: Promote Testnet to Mainnet

on:
  workflow_dispatch:
    inputs:
      comment:
        description: "Deployment context or reason"
        required: true
        default: ""
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate Workflow Context
    runs-on: ubuntu-latest
    steps:
      - name: Require workflow from master
        run: |
          if [ "${GITHUB_REF_NAME}" != "master" ]; then
            echo "This workflow must be run from master." >&2
            exit 1
          fi

  compute:
    name: Compute Release Metadata
    needs: validate
    uses: ./.github/workflows/_compute_release.yml
    secrets: inherit

  notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: compute
    outputs:
      release_name: ${{ steps.notes.outputs.name }}
      release_body: ${{ steps.notes.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.compute.outputs.target_sha }}
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        uses: zetamarkets/release-actions/generate-release-notes@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          tag_name: ${{ needs.compute.outputs.tag_name }}
          target_sha: ${{ needs.compute.outputs.target_sha }}
          previous_tag: ${{ needs.compute.outputs.previous_tag }}
          token: ${{ github.token }}

  slack_gate:
    name: Slack approvals
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [compute, notes]
    steps:
      - name: Prepare release context inputs
        id: context_inputs
        env:
          RELEASE_NAME: ${{ needs.notes.outputs.release_name }}
          DEPLOY_COMMENT: ${{ inputs.comment }}
          RELEASE_BODY: ${{ needs.notes.outputs.release_body }}
        run: |
          set -x
          release_tag="${{ needs.compute.outputs.tag_name }}"
          release_branch="${{ needs.compute.outputs.release_branch }}"
          testnet_branch="${{ vars.TESTNET_RELEASE_BRANCH }}"
          release_name="${RELEASE_NAME}"
          target_sha="${{ needs.compute.outputs.target_sha }}"
          short_sha="${target_sha:0:12}"
          deploy_comment="${DEPLOY_COMMENT}"
          release_body="${RELEASE_BODY}"

          items_json=$(jq -nc \
            --arg release_tag "$release_tag" \
            --arg release_branch "$release_branch" \
            --arg testnet_branch "$testnet_branch" \
            --arg release_name "$release_name" \
            --arg short_sha "$short_sha" \
            '[
              {"label":"Release Tag","value":$release_tag},
              {"label":"Release Branch","value":$release_branch},
              {"label":"Testnet Branch","value":$testnet_branch},
              {"label":"Release Name","value":$release_name},
              {"label":"Target SHA","value":$short_sha}
            ]')

          warning=""
          if [ -n "$testnet_branch" ] && [ -n "$release_branch" ] && [ "$testnet_branch" != "$release_branch" ]; then
            warning="*Warning:* Testnet is currently pointed to \\`$testnet_branch\\`."
          fi

          intro=""
          if [ -n "$deploy_comment" ]; then
            intro="*Deploy Comment:* ${deploy_comment}"
          fi

          footer=""
          if [ -n "$release_body" ]; then
            max=2000
            if [ ${#release_body} -gt $max ]; then
              release_body="${release_body:0:$((max-3))}..."
            fi
            footer="*Changelog:*\\n${release_body}"
          fi

          {
            echo "items_json<<EOF"
            echo "$items_json"
            echo "EOF"
            echo "warning<<EOF"
            echo "$warning"
            echo "EOF"
            echo "intro<<EOF"
            echo "$intro"
            echo "EOF"
            echo "footer<<EOF"
            echo "$footer"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build release context
        id: release_context
        uses: zetamarkets/release-actions/build-release-context@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          title: "Promote Release"
          intro: ${{ steps.context_inputs.outputs.intro }}
          items_json: ${{ steps.context_inputs.outputs.items_json }}
          warning: ${{ steps.context_inputs.outputs.warning }}
          footer: ${{ steps.context_inputs.outputs.footer }}

      - name: Slack approvals (require 2 of 5)
        uses: zetamarkets/slack-approval-gha@cedd2c748ebf33b1a11006a6644b7b97ea38384f
        env:
          SLACK_APP_TOKEN: ${{ secrets.SLACK_APP_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          # This is the #deveops-mainnet channel
          SLACK_CHANNEL_ID: C09E2HVEACW
        with:
          # real names behind user ids: chetan,tristan,nick,filip,kalyan,bernhard,kelvin
          approvers: U09RNQ8AH8D,U0467434P9T,U08DGEX878D,U045NTPJA07,U09TM6JD3B3,U09RS872QHG,U0460L4DH4L
          minimumApprovalCount: 2
          custom-blocks: ${{ steps.release_context.outputs.release_context }}

  build_push:
    name: Build and Push Image
    needs: compute
    uses: ./.github/workflows/_build_and_push.yml
    with:
      ref: ${{ needs.compute.outputs.target_sha }}
      image_tag: ${{ needs.compute.outputs.image_tag }}
      latest_tag: latest-mainnet
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      ecr_repository: hyperlane
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
    secrets: inherit

  create_release:
    name: Tag and Publish Release
    runs-on: ubuntu-latest
    needs: [compute, notes, build_push, slack_gate]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.compute.outputs.target_sha }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Create and push tag
        env:
          TAG_NAME: ${{ needs.compute.outputs.tag_name }}
          TARGET_SHA: ${{ needs.compute.outputs.target_sha }}
        run: |
          set -euo pipefail
          git fetch --tags --force
          git tag -a "${TAG_NAME}" "${TARGET_SHA}" -m "Release ${TAG_NAME}"
          git push origin "${TAG_NAME}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.compute.outputs.tag_name }}
          name: ${{ needs.notes.outputs.release_name }}
          body: ${{ needs.notes.outputs.release_body }}
          target_commitish: ${{ needs.compute.outputs.target_sha }}

  deploy:
    name: Deploy Mainnet
    needs: [compute, create_release]
    uses: ./.github/workflows/_deploy_k8s.yml
    with:
      ref: ${{ needs.compute.outputs.target_sha }}
      deploy_env: mainnet
      image_tag: ${{ needs.compute.outputs.image_tag }}
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
      aws_deploy_role_arn: arn:aws:iam::010222938823:role/bullet-gha-role
      eks_cluster_name: cluster
    secrets: inherit
