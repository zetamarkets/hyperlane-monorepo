name: Compute Release Metadata

on:
  workflow_call:
    outputs:
      release_branch:
        description: "Release branch"
        value: ${{ jobs.compute.outputs.release_branch }}
      release_num:
        description: "Release number"
        value: ${{ jobs.compute.outputs.release_num }}
      tag_name:
        description: "Release tag"
        value: ${{ jobs.compute.outputs.tag_name }}
      previous_tag:
        description: "Previous tag"
        value: ${{ jobs.compute.outputs.previous_tag }}
      target_sha:
        description: "Target SHA"
        value: ${{ jobs.compute.outputs.target_sha }}
      image_tag:
        description: "Image tag"
        value: ${{ jobs.compute.outputs.image_tag }}

permissions:
  contents: read

jobs:
  compute:
    name: Compute Release Metadata
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.release_branch.outputs.release_branch }}
      release_num: ${{ steps.compute.outputs.release_num }}
      tag_name: ${{ steps.compute.outputs.next_tag }}
      previous_tag: ${{ steps.compute.outputs.previous_tag }}
      target_sha: ${{ steps.compute.outputs.target_sha }}
      image_tag: ${{ steps.image.outputs.image_tag }}
    steps:
      - name: Normalize testnet release branch
        id: normalize
        run: |
          set -euo pipefail
          raw="${{ vars.TESTNET_RELEASE_BRANCH }}"
          if [ -z "$raw" ]; then
            echo "TESTNET_RELEASE_BRANCH is not set." >&2
            exit 1
          fi
          trimmed="$(echo "$raw" | xargs)"
          normalized="${trimmed#refs/heads/}"
          if [ -z "$normalized" ]; then
            echo "TESTNET_RELEASE_BRANCH is empty after normalization." >&2
            exit 1
          fi
          echo "normalized=$normalized" >> "$GITHUB_OUTPUT"

      - name: Validate testnet release branch
        run: |
          if ! echo "${{ steps.normalize.outputs.normalized }}" | grep -Eq '^release-[0-9]+$'; then
            echo "Invalid TESTNET_RELEASE_BRANCH: ${{ steps.normalize.outputs.normalized }}" >&2
            exit 1
          fi

      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.normalize.outputs.normalized }}
          fetch-depth: 0

      - name: Set release branch output
        id: release_branch
        run: |
          echo "release_branch=${{ steps.normalize.outputs.normalized }}" >> "$GITHUB_OUTPUT"

      - name: Compute release metadata
        id: compute
        uses: zetamarkets/release-actions/compute-release@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          branch_name: ${{ steps.normalize.outputs.normalized }}
          branch_regex: '^release-(\d+)$'
          branch_num_group: '1'
          tag_regex: '^v(\d+)\.(\d+)$'
          tag_release_group: '1'
          tag_fix_group: '2'
          tag_template: 'v{release_num}.{fix_num}'

      - name: Compute mainnet image tag
        id: image
        uses: zetamarkets/release-actions/compute-image-tag@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          template: 'v{release_num}.{fix_num}-{short_sha}-mainnet'
          release_num: ${{ steps.compute.outputs.release_num }}
          fix_num: ${{ steps.compute.outputs.fix_num }}
