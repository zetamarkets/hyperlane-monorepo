name: Point Testnet Release Branch

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch to deploy on testnet (release-<num>)'
        required: true
        type: string

permissions:
  actions: write
  contents: read

jobs:
  point:
    name: Set testnet release branch
    runs-on: ubuntu-latest
    steps:
      - name: Require workflow from master
        run: |
          if [ "${GITHUB_REF_NAME}" != "master" ]; then
            echo "This workflow must be run from master." >&2
            exit 1
          fi

      - name: Validate release branch
        run: |
          if [[ ! "${{ inputs.release_branch }}" =~ ^release-[0-9]+$ ]]; then
            echo "Invalid release branch: ${{ inputs.release_branch }}" >&2
            exit 1
          fi

      - id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.BULLET_DEPLOY_APP_ID }}
          private-key: ${{ secrets.BULLET_DEPLOY_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Verify release branch exists
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          branch="${{ inputs.release_branch }}"
          if ! gh api -H "Accept: application/vnd.github+json" "/repos/${{ github.repository }}/branches/${branch}" >/dev/null; then
            echo "Release branch does not exist: ${branch}" >&2
            exit 1
          fi

      - name: Update TESTNET_RELEASE_BRANCH variable
        uses: zetamarkets/release-actions/set-repo-var@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          var_name: TESTNET_RELEASE_BRANCH
          var_value: ${{ inputs.release_branch }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Build dispatch inputs
        id: dispatch_inputs
        run: |
          inputs_json=$(jq -nc --arg release_branch "${{ inputs.release_branch }}" '{release_branch:$release_branch}')
          echo "inputs_json<<EOF" >> "$GITHUB_OUTPUT"
          echo "$inputs_json" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Trigger testnet deploy
        uses: zetamarkets/release-actions/dispatch-workflow@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          workflow: deploy_testnet.yml
          ref: master
          inputs_json: ${{ steps.dispatch_inputs.outputs.inputs_json }}
          token: ${{ steps.app-token.outputs.token }}
