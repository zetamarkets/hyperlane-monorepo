name: Master Staging Deploy

on:
  push:
    branches: [master]

permissions:
  contents: read
  id-token: write

jobs:
  meta:
    name: Resolve Staging Metadata
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Compute staging image tag
        id: tag
        uses: zetamarkets/release-actions/compute-image-tag@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          template: '{date}-{short_sha}'
          latest_template: 'latest'

  build_push:
    name: Build and Push Image
    needs: meta
    uses: ./.github/workflows/_build_and_push.yml
    with:
      ref: ${{ github.sha }}
      image_tag: ${{ needs.meta.outputs.image_tag }}
      latest_tag: latest
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      ecr_repository: hyperlane
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
    secrets: inherit

  deploy:
    name: Deploy Staging
    needs: [meta, build_push]
    uses: ./.github/workflows/_deploy_k8s.yml
    with:
      ref: ${{ github.sha }}
      deploy_env: staging
      image_tag: ${{ needs.meta.outputs.image_tag }}
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
      aws_deploy_role_arn: arn:aws:iam::217494637380:role/bullet-gha-role
      eks_cluster_name: cluster
    secrets: inherit
