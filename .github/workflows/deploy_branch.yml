name: Manual Deploy Branch (Staging/Testnet)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        type: choice
        options:
          - staging
          - testnet
        required: true
      ref:
        description: 'Optional ref override (if different from selected branch)'
        type: string
        required: false
        default: ''

permissions:
  contents: read
  id-token: write

jobs:
  meta:
    name: Resolve Manual Deploy Metadata
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
      latest_tag: ${{ steps.meta.outputs.latest_template }}
      deploy_role_arn: ${{ steps.meta.outputs.deploy_role_arn }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
    steps:
      - name: Resolve ref
        id: ref
        run: |
          if [ -n "${{ inputs.ref }}" ]; then
            echo "ref=${{ inputs.ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}
          fetch-depth: 0

      - name: Resolve deploy metadata
        id: meta
        run: |
          deploy_env="${{ inputs.environment }}"
          ref_name="${{ steps.ref.outputs.ref }}"
          commit_sha=$(git rev-parse HEAD)

          template=""
          latest_template=""
          deploy_role_arn=""
          release_num=""

          if [ "$deploy_env" = "staging" ]; then
            template="{date}-{short_sha}"
            latest_template="latest"
            deploy_role_arn="arn:aws:iam::217494637380:role/bullet-gha-role"
          elif [ "$deploy_env" = "testnet" ]; then
            latest_template="latest-testnet"
            deploy_role_arn="arn:aws:iam::731781083829:role/bullet-gha-role"
            if [[ "$ref_name" =~ ^release-([0-9]+)$ ]]; then
              release_num="${BASH_REMATCH[1]}"
              template="release-{release_num}-{short_sha}-testnet"
            else
              template="manual-{short_sha}-testnet"
            fi
          else
            echo "Unknown environment: $deploy_env" >&2
            exit 1
          fi

          echo "template=$template" >> "$GITHUB_OUTPUT"
          echo "latest_template=$latest_template" >> "$GITHUB_OUTPUT"
          echo "deploy_role_arn=$deploy_role_arn" >> "$GITHUB_OUTPUT"
          echo "release_num=$release_num" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$commit_sha" >> "$GITHUB_OUTPUT"

      - name: Compute image tag
        id: tag
        uses: zetamarkets/release-actions/compute-image-tag@a6d5d3185fe2d19fa13047463722c245c7bce4ff
        with:
          template: ${{ steps.meta.outputs.template }}
          latest_template: ${{ steps.meta.outputs.latest_template }}
          release_num: ${{ steps.meta.outputs.release_num }}

  build_push:
    name: Build and Push Image
    needs: meta
    uses: ./.github/workflows/_build_and_push.yml
    with:
      ref: ${{ needs.meta.outputs.commit_sha }}
      image_tag: ${{ needs.meta.outputs.image_tag }}
      latest_tag: ${{ needs.meta.outputs.latest_tag }}
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      ecr_repository: hyperlane
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
    secrets: inherit

  deploy:
    name: Deploy
    needs: [meta, build_push]
    uses: ./.github/workflows/_deploy_k8s.yml
    with:
      ref: ${{ needs.meta.outputs.commit_sha }}
      deploy_env: ${{ inputs.environment }}
      image_tag: ${{ needs.meta.outputs.image_tag }}
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
      aws_deploy_role_arn: ${{ needs.meta.outputs.deploy_role_arn }}
      eks_cluster_name: cluster
    secrets: inherit
