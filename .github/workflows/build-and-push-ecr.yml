name: Build and Push Agent to ECR

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (branch, tag, or SHA)'
        required: false
        default: 'master'

permissions:
  contents: read
  id-token: write

concurrency:
  group: build-push-ecr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  meta:
    name: Resolve Build Metadata
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
      latest_tag: ${{ steps.tag.outputs.latest_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.sha }}
          fetch-depth: 0

      - name: Compute image tag
        id: tag
        run: |
          DATE=$(date -u +'%Y%m%d-%H%M%S')
          SHORT_SHA=$(echo "${{ github.event.inputs.ref || github.sha }}" | cut -c1-7)
          echo "image_tag=${DATE}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=latest" >> "$GITHUB_OUTPUT"

  build_push:
    name: Build and Push Image
    needs: meta
    uses: ./.github/workflows/_build_and_push.yml
    with:
      ref: ${{ github.event.inputs.ref || github.sha }}
      image_tag: ${{ needs.meta.outputs.image_tag }}
      latest_tag: ${{ needs.meta.outputs.latest_tag }}
      aws_region: ap-northeast-1
      ecr_registry: 840153641671.dkr.ecr.ap-northeast-1.amazonaws.com
      ecr_repository: hyperlane
      aws_ecr_role_arn: arn:aws:iam::840153641671:role/hyperlane-gha
    secrets: inherit
